// apps/api/prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

// ENUMS

enum UserRole {
  admin
  creator
  customer
}

enum Platform {
  telegram
  discord
  whatsapp
}

enum AccessStatus {
  granted
  revoked
  pending
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  unpaid
}

enum BillingInterval {
  month
  year
}

enum CreatorPlan {
  free
  starter
  pro
}



// MODELS

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String?
  passwordHash     String?
  role             UserRole @default(customer)
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  creator               Creator?
  subscriptions         Subscription[]
  telegramUsers         TelegramUser[]
  telegramVerifications TelegramVerification[]
}

model Creator {
  id              String  @id @default(uuid())
  userId          String  @unique
  handle          String  @unique
  bio             String?

  plan            CreatorPlan @default(free)
  razorpaySubId   String?
  commissionPct   Float        @default(15)
  planStartedAt   DateTime?
  planExpiresAt   DateTime?

  pricingPlan     Json?
  stripeAccountId String?
  telegramUserId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                  User                   @relation(fields: [userId], references: [id])
  products              Product[]
  integrations          IntegrationSettings[]
  affiliates            Affiliate[]
  telegramGroups        TelegramGroup[]
  telegramVerifications TelegramVerification[]
  telegramActivityLogs  TelegramActivityLog[]
  pages                 CreatorPage[]

  Page Page[]
}

model Product {
  id                  String           @id @default(uuid())
  creatorId           String
  title               String
  description         String?
  priceCents          Int
  currency            String           @default("usd")
  billingInterval     BillingInterval?
  stripePriceId       String?
  platformIntegration Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  creator        Creator         @relation(fields: [creatorId], references: [id])
  subscriptions  Subscription[]
  telegramGroups TelegramGroup[] @relation("ProductGroups")
  pages CreatorPage[] @relation("PageProducts")

}

model Subscription {
  id                      String             @id @default(uuid())
  userId                  String
  productId               String

  provider                String             // "stripe" | "razorpay"
  providerSubscriptionId  String?
  providerCustomerId      String?

  status                  SubscriptionStatus @default(active)
  stripeSubscriptionId    String?
  stripeCheckoutSessionId String?
  plan                    CreatorPlan?
  currentPeriodEnd        DateTime?
  warned24h               Boolean            @default(false)
  warnedExpired           Boolean            @default(false)
  kickAfter               DateTime?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  product        Product?         @relation(fields: [productId], references: [id])
  accessControls AccessControl[]
}

model AccessControl {
  id             String    @id @default(uuid())
  subscriptionId String
  platform       Platform
  platformUserId String?
  status         String    @default("pending")
  grantedAt      DateTime?
  revokedAt      DateTime?
  metadata       Json?

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
}

model IntegrationSettings {
  id        String   @id @default(uuid())
  creatorId String
  platform  Platform
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator Creator @relation(fields: [creatorId], references: [id])
}

model Affiliate {
  id            String   @id @default(uuid())
  code          String   @unique
  creatorId     String
  commissionPct Float
  createdAt     DateTime @default(now())

  creator Creator @relation(fields: [creatorId], references: [id])
}

model Job {
  id          String    @id @default(uuid())
  type        String
  payload     Json
  status      String    @default("pending")
  attempts    Int       @default(0)
  result      Json?
  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

model TelegramUser {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  tgUserId   BigInt   @unique
  tgUsername String?
  createdAt  DateTime @default(now())
}

model TelegramGroup {
  id           String                @id @default(cuid())
  creatorId    String
  creator      Creator               @relation(fields: [creatorId], references: [id])
  tgGroupId    BigInt                @unique // Telegram's chat.id
  inviteLink   String
  title        String?
  username     String?
  type         String? // "supergroup" | "channel"
  isConnected  Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt // ðŸ‘ˆ NEW â€” track changes
  products     Product[]             @relation("ProductGroups")
  activityLogs TelegramActivityLog[]
}

model TelegramVerification {
  id        String   @id @default(uuid())
  userId    String
  creatorId String
  code      String   @unique
  verified  Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  creator Creator @relation(fields: [creatorId], references: [id])
}

model TelegramActivityLog {
  id        String   @id @default(uuid())
  creatorId String
  groupId   String // references TelegramGroup.id
  tgUserId  BigInt
  event     String // "join", "allowed", "kick", "auto_add", "subscription_expired", etc.
  reason    String?
  createdAt DateTime @default(now())

  creator Creator       @relation(fields: [creatorId], references: [id])
  group   TelegramGroup @relation(fields: [groupId], references: [id])
}

// -----------------------------
// Creator Sales Page models
// -----------------------------
model CreatorPage {
  id          String   @id @default(uuid())
  creatorId   String
  slug        String   @unique
  title       String
  description String?
  color       String? // theme color hex
  themeColor1 String?
  themeColor2 String?
  heroImage   String? // url/key
  heroVideo   String? // url/key (optional)
  settings    Json? // generic settings (currency, showAccessIcons, etc.)
  sections    Json? // array of ordered blocks (flexible)
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator  Creator       @relation(fields: [creatorId], references: [id])
  previews PagePreview[]
  products Product[] @relation("PageProducts")
  @@unique([creatorId, slug])
}

model PagePreview {
  id          String   @id @default(uuid())
  pageId      String
  previewJson Json
  createdAt   DateTime @default(now())

  page CreatorPage @relation(fields: [pageId], references: [id])
}

model Page {
  id         String   @id @default(uuid())
  creatorId  String
  slug       String   @unique
  title      String?
  subtitle   String?
  themeColor1 String?   // gradient start
  themeColor2 String?   // gradient end
  heroImage  String?
  heroVideo  String?
  sections   Json? // Array of ordered blocks
  published  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  creator Creator @relation(fields: [creatorId], references: [id])
}
